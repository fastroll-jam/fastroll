use crate::error::VMCoreError;

/// PVM Opcodes
#[repr(u8)]
#[derive(Clone, Copy, Debug, Default)]
#[allow(non_camel_case_types)]
pub enum Opcode {
    #[default]
    TRAP = 0,
    FALLTHROUGH = 1,
    ECALLI = 10,
    LOAD_IMM_64 = 20,
    STORE_IMM_U8 = 30,
    STORE_IMM_U16 = 31,
    STORE_IMM_U32 = 32,
    STORE_IMM_U64 = 33,
    JUMP = 40,
    JUMP_IND = 50,
    LOAD_IMM = 51,
    LOAD_U8 = 52,
    LOAD_I8 = 53,
    LOAD_U16 = 54,
    LOAD_I16 = 55,
    LOAD_U32 = 56,
    LOAD_I32 = 57,
    LOAD_U64 = 58,
    STORE_U8 = 59,
    STORE_U16 = 60,
    STORE_U32 = 61,
    STORE_U64 = 62,
    STORE_IMM_IND_U8 = 70,
    STORE_IMM_IND_U16 = 71,
    STORE_IMM_IND_U32 = 72,
    STORE_IMM_IND_U64 = 73,
    LOAD_IMM_JUMP = 80,
    BRANCH_EQ_IMM = 81,
    BRANCH_NE_IMM = 82,
    BRANCH_LT_U_IMM = 83,
    BRANCH_LE_U_IMM = 84,
    BRANCH_GE_U_IMM = 85,
    BRANCH_GT_U_IMM = 86,
    BRANCH_LT_S_IMM = 87,
    BRANCH_LE_S_IMM = 88,
    BRANCH_GE_S_IMM = 89,
    BRANCH_GT_S_IMM = 90,
    MOVE_REG = 100,
    SBRK = 101,
    COUNT_SET_BITS_64 = 102,
    COUNT_SET_BITS_32 = 103,
    LEADING_ZERO_BITS_64 = 104,
    LEADING_ZERO_BITS_32 = 105,
    TRAILING_ZERO_BITS_64 = 106,
    TRAILING_ZERO_BITS_32 = 107,
    SIGN_EXTEND_8 = 108,
    SIGN_EXTEND_16 = 109,
    ZERO_EXTEND_16 = 110,
    REVERSE_BYTES = 111,
    STORE_IND_U8 = 120,
    STORE_IND_U16 = 121,
    STORE_IND_U32 = 122,
    STORE_IND_U64 = 123,
    LOAD_IND_U8 = 124,
    LOAD_IND_I8 = 125,
    LOAD_IND_U16 = 126,
    LOAD_IND_I16 = 127,
    LOAD_IND_U32 = 128,
    LOAD_IND_I32 = 129,
    LOAD_IND_U64 = 130,
    ADD_IMM_32 = 131,
    AND_IMM = 132,
    XOR_IMM = 133,
    OR_IMM = 134,
    MUL_IMM_32 = 135,
    SET_LT_U_IMM = 136,
    SET_LT_S_IMM = 137,
    SHLO_L_IMM_32 = 138,
    SHLO_R_IMM_32 = 139,
    SHAR_R_IMM_32 = 140,
    NEG_ADD_IMM_32 = 141,
    SET_GT_U_IMM = 142,
    SET_GT_S_IMM = 143,
    SHLO_L_IMM_ALT_32 = 144,
    SHLO_R_IMM_ALT_32 = 145,
    SHAR_R_IMM_ALT_32 = 146,
    CMOV_IZ_IMM = 147,
    CMOV_NZ_IMM = 148,
    ADD_IMM_64 = 149,
    MUL_IMM_64 = 150,
    SHLO_L_IMM_64 = 151,
    SHLO_R_IMM_64 = 152,
    SHAR_R_IMM_64 = 153,
    NEG_ADD_IMM_64 = 154,
    SHLO_L_IMM_ALT_64 = 155,
    SHLO_R_IMM_ALT_64 = 156,
    SHAR_R_IMM_ALT_64 = 157,
    ROT_R_64_IMM = 158,
    ROT_R_64_IMM_ALT = 159,
    ROT_R_32_IMM = 160,
    ROT_R_32_IMM_ALT = 161,
    BRANCH_EQ = 170,
    BRANCH_NE = 171,
    BRANCH_LT_U = 172,
    BRANCH_LT_S = 173,
    BRANCH_GE_U = 174,
    BRANCH_GE_S = 175,
    LOAD_IMM_JUMP_IND = 180,
    ADD_32 = 190,
    SUB_32 = 191,
    MUL_32 = 192,
    DIV_U_32 = 193,
    DIV_S_32 = 194,
    REM_U_32 = 195,
    REM_S_32 = 196,
    SHLO_L_32 = 197,
    SHLO_R_32 = 198,
    SHAR_R_32 = 199,
    ADD_64 = 200,
    SUB_64 = 201,
    MUL_64 = 202,
    DIV_U_64 = 203,
    DIV_S_64 = 204,
    REM_U_64 = 205,
    REM_S_64 = 206,
    SHLO_L_64 = 207,
    SHLO_R_64 = 208,
    SHAR_R_64 = 209,
    AND = 210,
    XOR = 211,
    OR = 212,
    MUL_UPPER_S_S = 213,
    MUL_UPPER_U_U = 214,
    MUL_UPPER_S_U = 215,
    SET_LT_U = 216,
    SET_LT_S = 217,
    CMOV_IZ = 218,
    CMOV_NZ = 219,
    ROT_L_64 = 220,
    ROT_L_32 = 221,
    ROT_R_64 = 222,
    ROT_R_32 = 223,
    AND_INV = 224,
    OR_INV = 225,
    XNOR = 226,
    MAX = 227,
    MAX_U = 228,
    MIN = 229,
    MIN_U = 230,
}

impl TryFrom<u8> for Opcode {
    type Error = VMCoreError;

    fn try_from(value: u8) -> Result<Opcode, VMCoreError> {
        match value {
            0 => Ok(Opcode::TRAP),
            1 => Ok(Opcode::FALLTHROUGH),
            10 => Ok(Opcode::ECALLI),
            20 => Ok(Opcode::LOAD_IMM_64),
            30 => Ok(Opcode::STORE_IMM_U8),
            31 => Ok(Opcode::STORE_IMM_U16),
            32 => Ok(Opcode::STORE_IMM_U32),
            33 => Ok(Opcode::STORE_IMM_U64),
            40 => Ok(Opcode::JUMP),
            50 => Ok(Opcode::JUMP_IND),
            51 => Ok(Opcode::LOAD_IMM),
            52 => Ok(Opcode::LOAD_U8),
            53 => Ok(Opcode::LOAD_I8),
            54 => Ok(Opcode::LOAD_U16),
            55 => Ok(Opcode::LOAD_I16),
            56 => Ok(Opcode::LOAD_U32),
            57 => Ok(Opcode::LOAD_I32),
            58 => Ok(Opcode::LOAD_U64),
            59 => Ok(Opcode::STORE_U8),
            60 => Ok(Opcode::STORE_U16),
            61 => Ok(Opcode::STORE_U32),
            62 => Ok(Opcode::STORE_U64),
            70 => Ok(Opcode::STORE_IMM_IND_U8),
            71 => Ok(Opcode::STORE_IMM_IND_U16),
            72 => Ok(Opcode::STORE_IMM_IND_U32),
            73 => Ok(Opcode::STORE_IMM_IND_U64),
            80 => Ok(Opcode::LOAD_IMM_JUMP),
            81 => Ok(Opcode::BRANCH_EQ_IMM),
            82 => Ok(Opcode::BRANCH_NE_IMM),
            83 => Ok(Opcode::BRANCH_LT_U_IMM),
            84 => Ok(Opcode::BRANCH_LE_U_IMM),
            85 => Ok(Opcode::BRANCH_GE_U_IMM),
            86 => Ok(Opcode::BRANCH_GT_U_IMM),
            87 => Ok(Opcode::BRANCH_LT_S_IMM),
            88 => Ok(Opcode::BRANCH_LE_S_IMM),
            89 => Ok(Opcode::BRANCH_GE_S_IMM),
            90 => Ok(Opcode::BRANCH_GT_S_IMM),
            100 => Ok(Opcode::MOVE_REG),
            101 => Ok(Opcode::SBRK),
            102 => Ok(Opcode::COUNT_SET_BITS_64),
            103 => Ok(Opcode::COUNT_SET_BITS_32),
            104 => Ok(Opcode::LEADING_ZERO_BITS_64),
            105 => Ok(Opcode::LEADING_ZERO_BITS_32),
            106 => Ok(Opcode::TRAILING_ZERO_BITS_64),
            107 => Ok(Opcode::TRAILING_ZERO_BITS_32),
            108 => Ok(Opcode::SIGN_EXTEND_8),
            109 => Ok(Opcode::SIGN_EXTEND_16),
            110 => Ok(Opcode::ZERO_EXTEND_16),
            111 => Ok(Opcode::REVERSE_BYTES),
            120 => Ok(Opcode::STORE_IND_U8),
            121 => Ok(Opcode::STORE_IND_U16),
            122 => Ok(Opcode::STORE_IND_U32),
            123 => Ok(Opcode::STORE_IND_U64),
            124 => Ok(Opcode::LOAD_IND_U8),
            125 => Ok(Opcode::LOAD_IND_I8),
            126 => Ok(Opcode::LOAD_IND_U16),
            127 => Ok(Opcode::LOAD_IND_I16),
            128 => Ok(Opcode::LOAD_IND_U32),
            129 => Ok(Opcode::LOAD_IND_I32),
            130 => Ok(Opcode::LOAD_IND_U64),
            131 => Ok(Opcode::ADD_IMM_32),
            132 => Ok(Opcode::AND_IMM),
            133 => Ok(Opcode::XOR_IMM),
            134 => Ok(Opcode::OR_IMM),
            135 => Ok(Opcode::MUL_IMM_32),
            136 => Ok(Opcode::SET_LT_U_IMM),
            137 => Ok(Opcode::SET_LT_S_IMM),
            138 => Ok(Opcode::SHLO_L_IMM_32),
            139 => Ok(Opcode::SHLO_R_IMM_32),
            140 => Ok(Opcode::SHAR_R_IMM_32),
            141 => Ok(Opcode::NEG_ADD_IMM_32),
            142 => Ok(Opcode::SET_GT_U_IMM),
            143 => Ok(Opcode::SET_GT_S_IMM),
            144 => Ok(Opcode::SHLO_L_IMM_ALT_32),
            145 => Ok(Opcode::SHLO_R_IMM_ALT_32),
            146 => Ok(Opcode::SHAR_R_IMM_ALT_32),
            147 => Ok(Opcode::CMOV_IZ_IMM),
            148 => Ok(Opcode::CMOV_NZ_IMM),
            149 => Ok(Opcode::ADD_IMM_64),
            150 => Ok(Opcode::MUL_IMM_64),
            151 => Ok(Opcode::SHLO_L_IMM_64),
            152 => Ok(Opcode::SHLO_R_IMM_64),
            153 => Ok(Opcode::SHAR_R_IMM_64),
            154 => Ok(Opcode::NEG_ADD_IMM_64),
            155 => Ok(Opcode::SHLO_L_IMM_ALT_64),
            156 => Ok(Opcode::SHLO_R_IMM_ALT_64),
            157 => Ok(Opcode::SHAR_R_IMM_ALT_64),
            158 => Ok(Opcode::ROT_R_64_IMM),
            159 => Ok(Opcode::ROT_R_64_IMM_ALT),
            160 => Ok(Opcode::ROT_R_32_IMM),
            161 => Ok(Opcode::ROT_R_32_IMM_ALT),
            170 => Ok(Opcode::BRANCH_EQ),
            171 => Ok(Opcode::BRANCH_NE),
            172 => Ok(Opcode::BRANCH_LT_U),
            173 => Ok(Opcode::BRANCH_LT_S),
            174 => Ok(Opcode::BRANCH_GE_U),
            175 => Ok(Opcode::BRANCH_GE_S),
            180 => Ok(Opcode::LOAD_IMM_JUMP_IND),
            190 => Ok(Opcode::ADD_32),
            191 => Ok(Opcode::SUB_32),
            192 => Ok(Opcode::MUL_32),
            193 => Ok(Opcode::DIV_U_32),
            194 => Ok(Opcode::DIV_S_32),
            195 => Ok(Opcode::REM_U_32),
            196 => Ok(Opcode::REM_S_32),
            197 => Ok(Opcode::SHLO_L_32),
            198 => Ok(Opcode::SHLO_R_32),
            199 => Ok(Opcode::SHAR_R_32),
            200 => Ok(Opcode::ADD_64),
            201 => Ok(Opcode::SUB_64),
            202 => Ok(Opcode::MUL_64),
            203 => Ok(Opcode::DIV_U_64),
            204 => Ok(Opcode::DIV_S_64),
            205 => Ok(Opcode::REM_U_64),
            206 => Ok(Opcode::REM_S_64),
            207 => Ok(Opcode::SHLO_L_64),
            208 => Ok(Opcode::SHLO_R_64),
            209 => Ok(Opcode::SHAR_R_64),
            210 => Ok(Opcode::AND),
            211 => Ok(Opcode::XOR),
            212 => Ok(Opcode::OR),
            213 => Ok(Opcode::MUL_UPPER_S_S),
            214 => Ok(Opcode::MUL_UPPER_U_U),
            215 => Ok(Opcode::MUL_UPPER_S_U),
            216 => Ok(Opcode::SET_LT_U),
            217 => Ok(Opcode::SET_LT_S),
            218 => Ok(Opcode::CMOV_IZ),
            219 => Ok(Opcode::CMOV_NZ),
            220 => Ok(Opcode::ROT_L_64),
            221 => Ok(Opcode::ROT_L_32),
            222 => Ok(Opcode::ROT_R_64),
            223 => Ok(Opcode::ROT_R_32),
            224 => Ok(Opcode::AND_INV),
            225 => Ok(Opcode::OR_INV),
            226 => Ok(Opcode::XNOR),
            227 => Ok(Opcode::MAX),
            228 => Ok(Opcode::MAX_U),
            229 => Ok(Opcode::MIN),
            230 => Ok(Opcode::MIN_U),
            _ => Err(VMCoreError::InvalidOpcode),
        }
    }
}

impl Opcode {
    pub fn from_u8(value: u8) -> Result<Self, VMCoreError> {
        Self::try_from(value).map_err(|_| VMCoreError::InvalidOpcode)
    }

    pub fn is_termination_opcode(&self) -> bool {
        use Opcode::*;
        matches!(
            self,
            TRAP | FALLTHROUGH
                | JUMP
                | JUMP_IND
                | LOAD_IMM_JUMP
                | LOAD_IMM_JUMP_IND
                | BRANCH_EQ_IMM
                | BRANCH_NE_IMM
                | BRANCH_LT_U_IMM
                | BRANCH_LE_U_IMM
                | BRANCH_GE_U_IMM
                | BRANCH_GT_U_IMM
                | BRANCH_LT_S_IMM
                | BRANCH_LE_S_IMM
                | BRANCH_GE_S_IMM
                | BRANCH_GT_S_IMM
                | BRANCH_EQ
                | BRANCH_NE
                | BRANCH_LT_U
                | BRANCH_LT_S
                | BRANCH_GE_U
                | BRANCH_GE_S
        )
    }
}
